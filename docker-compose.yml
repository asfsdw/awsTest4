version: "1"

services:
  # 1. MySQL ë°ì´í„°ë² ì´ìŠ¤ ì„œë¹„ìŠ¤
  db:
    # MySQL 8.0 ê³µì‹ ì´ë¯¸ì§€ ì‚¬ìš©
    image: mysql:8.0
    # ì»¨í…Œì´ë„ˆ ì´ë¦„ ì§€ì • (ì„ íƒ ì‚¬í•­)
    container_name: mysql
    restart: always

    # ğŸ’¡ ìƒˆë¡œìš´ Health Check ì„¹ì…˜ ì¶”ê°€
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p$$MYSQL_ROOT_PASSWORD" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s # ì²˜ìŒ 10ì´ˆ ë™ì•ˆì€ ì‹¤íŒ¨í•´ë„ ë¬´ì‹œ

    # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
    environment:
      MYSQL_ROOT_PASSWORD: 1234
      MYSQL_DATABASE: seoul
      MYSQL_USER: test
      MYSQL_PASSWORD: test

    ports:
      - "3306:3306"

    # ë°ì´í„° ì˜ì†ì„±ì„ ìœ„í•œ ë³¼ë¥¨ ì„¤ì • (ì»¨í…Œì´ë„ˆ ì‚­ì œ í›„ì—ë„ ë°ì´í„° ìœ ì§€)
    volumes:
      - dbtest:/var/lib/mysql

  # 2. Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë¹„ìŠ¤(gitì— pushí• ë•ŒëŠ” ì•„ë˜ appì•ì˜ #ì„ ì œê±°ì‹œì¼œì¤€ë‹¤.(35~50ë²ˆí–‰)
  app:
    image: gouga117/springcicddemo1:latest
    container_name: spring-boot-app

    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://db:3306/seoul
      SPRING_DATASOURCE_USERNAME: test
      SPRING_DATASOURCE_PASSWORD: test

    ports:
      - "8888:8888"

    # 'db' ì„œë¹„ìŠ¤ê°€ ì™„ì „íˆ ì‹¤í–‰ëœ í›„ 'app' ì„œë¹„ìŠ¤ê°€ ì‹œì‘ë˜ë„ë¡ ë³´ì¥
    depends_on:
      db:
        condition: service_healthy

# ë°ì´í„° ì˜ì†ì„±ì„ ìœ„í•œ ë³¼ë¥¨ ì •ì˜
volumes:
  dbtest: